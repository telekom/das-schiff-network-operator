# SPDX-FileCopyrightText: 2025 Deutsche Telekom AG
#
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y llvm clang libbpf-dev gcc-multilib linux-headers-$(uname -r)
      - name: run code generators
        run: make generate
      - name: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: v2.8.0
          args: --timeout=10m

      - name: Run go vet
        run: go vet ./...

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "ERROR: go.mod or go.sum is not tidy. Run 'go mod tidy' and commit changes."
            exit 1
          fi

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y llvm clang libbpf-dev gcc-multilib linux-headers-$(uname -r)
      - name: Run Tests
        run: make test
      - name: Upload coverage report
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: cover.out
          fail_ci_if_error: false

  validate-generated:
    name: validate generated files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y llvm clang libbpf-dev gcc-multilib linux-headers-$(uname -r)
      - name: run code generators
        run: make generate
      - name: run manifest generators
        run: make manifests
      - name: ensure no files changed
        run: git diff --exit-code || (echo "Generated files are out of sync. Please run 'make generate manifests' and commit the updated files."; exit 1)

  build-images:
    name: build container images
    if: github.event.pull_request.head.repo.full_name == github.repository
    needs: [golangci, test, validate-generated]
    permissions:
      contents: read
      packages: write
      id-token: write
    uses: ./.github/workflows/build-images.yaml
    with:
      push: true
      cache-write: true

  build-images-fork:
    name: build container images (fork)
    if: github.event.pull_request.head.repo.full_name != github.repository
    needs: [golangci, test, validate-generated]
    permissions:
      contents: read
      # packages: write and id-token: write are required because GitHub statically
      # validates reusable workflow job permissions even when those jobs are
      # conditionally skipped. The build and manifest jobs in build-images.yaml
      # declare these permissions for registry push and cosign signing, but neither
      # runs for forks (inputs.push == false). For pull_request triggers from forks,
      # the GITHUB_TOKEN is automatically scoped to read-only by GitHub regardless
      # of what is declared here.
      packages: write
      id-token: write
    uses: ./.github/workflows/build-images.yaml
    with:
      push: false
