name: Build and Release Container Images

on:
  workflow_call:
    inputs:
      push:
        description: "Push images to registry"
        type: boolean
        default: true
      sign:
        description: "Sign images with cosign"
        type: boolean
        default: false
      sign-recursive:
        description: "Use --recursive flag for cosign (signs individual arch images)"
        type: boolean
        default: false
      sbom:
        description: "Generate and attach SBOM to images"
        type: boolean
        default: false
      cache-write:
        description: "Write to GHA build cache"
        type: boolean
        default: false

jobs:
  build:
    name: Build (${{ matrix.image }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - das-schiff-network-operator
          - das-schiff-cra-frr
          - das-schiff-nwop-agent-cra-frr
          - das-schiff-nwop-agent-cra-vsr
          - das-schiff-nwop-agent-netplan
          - das-schiff-nwop-agent-hbn-l2
        arch: ["amd64", "arm64"]
        include:
          - runner: ubuntu-latest
            arch: "amd64"
          - runner: ubuntu-24.04-arm
            arch: "arm64"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Create Licenses Report
        run: make licenses-report

      - name: Read Go version
        id: go-version
        run: echo "version=$(awk '/^go / { print $2 }' go.mod)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GitHub Container Registry
        if: inputs.push
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ghcr.io/telekom/${{ matrix.image }}
          # NOTE: tag config is duplicated in the manifest job below — keep in sync.
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          flavor: |
            latest=auto

      - name: Build and Push Image
        if: inputs.push
        id: build-push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          file: ${{ matrix.image }}.Dockerfile
          build-args: GO_VERSION=${{ steps.go-version.outputs.version }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true
          tags: ghcr.io/telekom/${{ matrix.image }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image }}-${{ matrix.arch }}
          cache-to: ${{ inputs.cache-write && format('type=gha,mode=max,scope={0}-{1}', matrix.image, matrix.arch) || '' }}

      - name: Build Image (no push)
        if: ${{ !inputs.push }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          file: ${{ matrix.image }}.Dockerfile
          build-args: GO_VERSION=${{ steps.go-version.outputs.version }}
          push: false
          cache-from: type=gha,scope=${{ matrix.image }}-${{ matrix.arch }}

      - name: Export digest
        if: inputs.push
        run: |
          mkdir -p ${{ runner.temp }}/digests-${{ matrix.image }}
          digest="${{ steps.build-push.outputs.digest }}"
          touch "${{ runner.temp }}/digests-${{ matrix.image }}/${digest#sha256:}"

      - name: Upload digest
        if: inputs.push
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.image }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/digests-${{ matrix.image }}/*
          if-no-files-found: error
          retention-days: 1

  manifest:
    name: Manifest (${{ matrix.image }})
    if: ${{ inputs.push }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - das-schiff-network-operator
          - das-schiff-cra-frr
          - das-schiff-nwop-agent-cra-frr
          - das-schiff-nwop-agent-cra-vsr
          - das-schiff-nwop-agent-netplan
          - das-schiff-nwop-agent-hbn-l2
    steps:
      - name: Download digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-${{ matrix.image }}-*
          merge-multiple: true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ghcr.io/telekom/${{ matrix.image }}
          # NOTE: tag config is duplicated in the build job above — keep in sync.
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          flavor: |
            latest=auto

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Create manifest list and push
        id: push
        working-directory: ${{ runner.temp }}/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'ghcr.io/telekom/${{ matrix.image }}@sha256:%s ' *)
          TAG=$(jq -cr '.tags[0]' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          echo "digest=$(docker buildx imagetools inspect "$TAG" --format '{{json .Manifest}}' | jq -r '.digest')" >> $GITHUB_OUTPUT

      - name: Install Cosign
        if: inputs.sign || inputs.sbom
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign container image
        if: inputs.sign
        run: |
          cosign sign --yes ${{ inputs.sign-recursive && '--recursive' || '' }} ghcr.io/telekom/${{ matrix.image }}@${{ steps.push.outputs.digest }}

      - name: Generate SBOM
        if: inputs.sbom
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        with:
          image: ghcr.io/telekom/${{ matrix.image }}@${{ steps.push.outputs.digest }}
          format: spdx-json
          output-file: sbom-${{ matrix.image }}.spdx.json

      - name: Attach SBOM to image
        if: inputs.sbom
        run: |
          cosign attach sbom --sbom sbom-${{ matrix.image }}.spdx.json ghcr.io/telekom/${{ matrix.image }}@${{ steps.push.outputs.digest }}

      - name: Upload SBOM as artifact
        if: inputs.sbom
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom-${{ matrix.image }}
          path: sbom-${{ matrix.image }}.spdx.json
