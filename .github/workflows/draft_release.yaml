name: Create Draft Release

on:
  push:
    tags:
      - "v*"

jobs:
  draft_release:
    name: Create Draft Release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - name: Install Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y llvm clang libbpf-dev gcc-multilib linux-headers-$(uname -r)

      - name: Build
        run: |
          make build

      - name: Create Licenses Report
        run: |
          make licenses-report

      - name: Determine version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Generate install manifests
        run: |
          make kustomize
          VERSION="${{ steps.version.outputs.version }}"
          REGISTRY="ghcr.io/telekom"
          mkdir -p out

          # All image targets to set version tags for
          IMAGES=(
            "das-schiff-network-operator"
            "das-schiff-cra-frr"
            "das-schiff-nwop-agent-cra-frr"
            "das-schiff-nwop-agent-cra-vsr"
            "das-schiff-nwop-agent-netplan"
            "das-schiff-nwop-agent-hbn-l2"
          )

          # Build kustomize set-image args: match by image name, set release tag
          # docker/metadata-action strips the v prefix (type=semver,pattern={{version}}),
          # so the pushed Docker tag is e.g. "1.2.3", not "v1.2.3".
          SET_IMAGE_ARGS=()
          for img in "${IMAGES[@]}"; do
            SET_IMAGE_ARGS+=("${REGISTRY}/${img}=${REGISTRY}/${img}:${VERSION}")
          done

          # --- Default install manifest (CRA-FRR, netplan, HBN-L2 agents) ---
          cd config/default
          bin/kustomize edit set image "${SET_IMAGE_ARGS[@]}"
          cd "${{ github.workspace }}"
          bin/kustomize build config/default > out/install.yaml
          echo "Generated install.yaml with $(wc -l < out/install.yaml) lines"

          # --- HBN standalone install manifest ---
          cd config/hbn-standalone
          bin/kustomize edit set image "${SET_IMAGE_ARGS[@]}"
          cd "${{ github.workspace }}"
          bin/kustomize build config/hbn-standalone > out/install-hbn-standalone.yaml
          echo "Generated install-hbn-standalone.yaml with $(wc -l < out/install-hbn-standalone.yaml) lines"

          # --- CRDs-only manifest ---
          bin/kustomize build config/crd > out/crds.yaml
          echo "Generated crds.yaml with $(wc -l < out/crds.yaml) lines"

          # Restore kustomization files modified by 'kustomize edit set image'
          git checkout -- config/default config/hbn-standalone

          # Verify no :latest images remain in generated manifests
          for f in out/install.yaml out/install-hbn-standalone.yaml; do
            if grep -q 'image:.*:latest' "$f"; then
              echo "::error file=$f::$f still contains :latest image references"
              grep 'image:.*:latest' "$f"
              exit 1
            fi
          done

      - name: Bundle project licenses
        run: |
          # Add top-level LICENSE and NOTICE into the existing licenses archive
          # created by 'make licenses-report' (which contains third-party licenses).
          mkdir -p out/licenses-staging
          tar -xf out/licenses.tar.gz -C out/licenses-staging 2>/dev/null || true
          cp LICENSE NOTICE out/licenses-staging/
          tar --sort=name --mtime='1970-01-01' --owner=0 --group=0 --numeric-owner \
            -cf - -C out/licenses-staging . | gzip -n > out/licenses.tar.gz
          rm -rf out/licenses-staging

      - name: Generate Release Notes
        id: release-notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            git log --pretty=format:"* %s (%h)" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## Changes since $PREV_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"* %s (%h)" $PREV_TAG..HEAD >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate checksums
        run: |
          cd out
          sha256sum *.yaml licenses.tar.gz > checksums.txt
          echo "Checksums:"
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          draft: true
          files: out/*.*
          body: ${{ steps.release-notes.outputs.notes }}
          generate_release_notes: true

  release-images:
    permissions:
      contents: read
      packages: write
      id-token: write
    uses: ./.github/workflows/build-images.yaml
    with:
      push: true
      sign: true
      sign-recursive: true
      sbom: true
